name: Build and Release

on:
  push:
    tags:
      - 'v*'  # ä»…åœ¨æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

permissions:
  contents: write  # æˆäºˆåˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶çš„æƒé™

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build with PyInstaller
        run: |
          pyinstaller arknight_AB_Auto_Package.spec --noconfirm
          
      - name: Verify build output
        run: |
          if (Test-Path "dist\Arknight_AB_Auto_Package\Arknight_AB_Auto_Package.exe") {
            Write-Host "âœ“ Build successful: EXE file found"
            Get-ChildItem "dist\Arknight_AB_Auto_Package" | Select-Object Name, Length
          } else {
            Write-Error "Build failed: EXE file not found"
            exit 1
          }
          
      - name: Get version from tag
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
      - name: Create ZIP archive
        run: |
          # å‹ç¼©æ•´ä¸ªåº”ç”¨ç¨‹åºç›®å½•ï¼ˆç›®å½•æ¨¡å¼æ‰“åŒ…ï¼‰
          Compress-Archive -Path "dist\Arknight_AB_Auto_Package\*" -DestinationPath "Arknight_AB_Tool_${{ steps.get_version.outputs.VERSION }}_Windows.zip"
          
          # æ˜¾ç¤ºå‹ç¼©åŒ…ä¿¡æ¯
          $zipFile = Get-Item "Arknight_AB_Tool_${{ steps.get_version.outputs.VERSION }}_Windows.zip"
          Write-Host "âœ“ Created ZIP archive: $($zipFile.Name)"
          Write-Host "  Size: $([math]::Round($zipFile.Length / 1MB, 2)) MB"
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Arknight_AB_Tool_${{ steps.get_version.outputs.VERSION }}
          path: dist/Arknight_AB_Auto_Package/
          retention-days: 30
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: æ˜æ—¥æ–¹èˆŸ AB æ‰“åŒ…å·¥å…· ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ï¿½ æ›´æ–°æ—¥å¿—
            
            ${{ github.event.head_commit.message }}
            
            ---
            
            ## ğŸ“– é¡¹ç›®ç®€ä»‹
            
            Unity èµ„æºç¼–è¾‘å™¨æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„æ¸¸æˆèµ„æºåŒ…å¤„ç†å·¥å…·ï¼Œæ”¯æŒå¤šæ¬¾çƒ­é—¨æ¸¸æˆçš„ Unity AssetBundle è§£å¯†ã€è§£åŒ…ã€ç¼–è¾‘å’Œé‡æ–°æ‰“åŒ…ã€‚
            
            **æ”¯æŒçš„æ¸¸æˆï¼š**
            - ğŸ¢ æ˜æ—¥æ–¹èˆŸ (Arknights)
            - âš”ï¸ äº¤é”™æˆ˜çº¿ (Cross Core)
            - ğŸ”„ é‡è¿”æœªæ¥1999 (Reverse: 1999)
            - ğŸ“¦ é€šç”¨ Unity èµ„æºåŒ…
            
            **å¼€å‘è€…ï¼š** [MODå®éªŒå®¤](https://www.modwu.com)
            
            **ğŸ’– æ”¯æŒé¡¹ç›®ï¼š**
            - â­ ç»™é¡¹ç›®ç‚¹ä¸ª Star
            - ğŸ”— åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹
            - ğŸ’° [èµåŠ©æ”¯æŒ](https://www.modwu.com/219.html)
            
            ---
            
            ## ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            ä¸‹è½½ ZIP æ–‡ä»¶åï¼Œè§£å‹åˆ°ä»»æ„ç›®å½•ï¼Œè¿è¡Œ `Arknight_AB_Auto_Package.exe` å³å¯ä½¿ç”¨ã€‚
            
            ## âœ¨ ä¸»è¦ç‰¹æ€§
            
            - ğŸ“ **ç›®å½•æ¨¡å¼æ‰“åŒ…**ï¼šå¯åŠ¨æ›´å¿«ï¼Œä½“ç§¯æ›´å°
            - ğŸ“ **æ—¥å¿—ç®¡ç†**ï¼šæ”¯æŒæŸ¥çœ‹ã€æ¸…ç†æ—¥å¿—æ–‡ä»¶
            - âš™ï¸ **é…ç½®ç®¡ç†**ï¼šé…ç½®æ–‡ä»¶ä¿å­˜åœ¨ `%LOCALAPPDATA%\ArknightABTool`
            - ğŸ¨ **ä¸»é¢˜æ”¯æŒ**ï¼šæ”¯æŒæµ…è‰²/æ·±è‰²ä¸»é¢˜åˆ‡æ¢
            - ğŸ”“ **æ™ºèƒ½è§£å¯†**ï¼šè‡ªåŠ¨è¯†åˆ«æ¸¸æˆç±»å‹å¹¶è§£å¯†
            
            ## ğŸ“‚ æ–‡ä»¶è¯´æ˜
            
            - `Arknight_AB_Auto_Package.exe` - ä¸»ç¨‹åº
            - `_internal/` - ä¾èµ–åº“å’Œèµ„æºæ–‡ä»¶
            
            ## ğŸ“Œ æ³¨æ„äº‹é¡¹
            
            - âœ… Windows 10/11 64ä½ç³»ç»Ÿ
            - âœ… é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ç­‰å¾…å‡ ç§’
            - âœ… æ—¥å¿—ä½ç½®ï¼š`%LOCALAPPDATA%\ArknightABTool\logs`
            - âœ… é…ç½®ä½ç½®ï¼š`%LOCALAPPDATA%\ArknightABTool\config.json`
            
            ## ğŸ”— ç›¸å…³é“¾æ¥
            
            - ğŸŒ [å®˜æ–¹ç½‘ç«™](https://www.modwu.com/219.html)
            - ğŸ“– [ä½¿ç”¨æ–‡æ¡£](https://github.com/laoxinH/Arknight_AB_Auto_Package/blob/main/README.md)
            - ğŸ’¬ [é—®é¢˜åé¦ˆ](https://github.com/laoxinH/Arknight_AB_Auto_Package/issues)
          draft: false
          prerelease: false
          files: |
            Arknight_AB_Tool_${{ steps.get_version.outputs.VERSION }}_Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
